---
title: "ã€Œã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã®ç†è«–ã¨å®Ÿè£…ã€ã‚’Swiftã§å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ–¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ios,swift]
published: false
---

ï¼ˆå°å…¥ï¼‰

* å…ˆäººã®äº‹ä¾‹
* ãªãœã‚„ã‚ã†ã¨æ€ã£ãŸã®ã‹
* ã©ã“ã¾ã§ã®ç¯„å›²ã‚’å«ã‚€ã‹

å®Ÿè£…é›£æ˜“åº¦è¡¨è¨˜

* â˜…â˜†â˜†â˜†â˜† : å‰æçŸ¥è­˜ã§ã»ã¼å®Œå…¨ã«å®Ÿè£…ã§ãã‚‹
* â˜…â˜…â˜†â˜†â˜† : æœ¬ã®å†…å®¹ã‚’è¿½ãˆã°å®Ÿè£…ã§ãã‚‹
* â˜…â˜…â˜…â˜†â˜† : æœ¬ã®å†…å®¹ã‚’è¿½ã„ã‹ã¤å°‘ã—è€ƒãˆã‚Œã°å®Ÿè£…ã§ãã‚‹
* â˜…â˜…â˜…â˜…â˜† : æœ¬ã®å†…å®¹ã‚’è¿½ã„ã‹ã¤ç†Ÿè€ƒã™ã‚Œã°å®Ÿè£…ã§ãã‚‹
* â˜…â˜…â˜…â˜…â˜… : æœ¬ã®å†…å®¹ã‚’è¿½ã„ã‹ã¤è€ƒãˆã¦ã‚‚å®Ÿè£…ãŒæ€ªã—ãã€æ·±ã„ç†è§£ãŒå¿…è¦

## 1ç« ã€€ãƒ–ãƒ¼ãƒ«è«–ç†

â˜…â˜…â˜…â˜†â˜†
ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¯ã‚µã®ã¨ã“ã‚ã§å°‘ã—æ‚©ã¿ã¾ã—ãŸãŒã€åœ°é“ã«æ¤œè¨ã™ã‚Œã°ã§ãã¾ã—ãŸã€‚
è«–ç†æ¼”ç®—ã«æ…£ã‚Œã‚‹ã¾ã§ãŒã¤ã‚‰ã‹ã£ãŸã§ã™ã€‚

å…¨ã¦ã®ãƒ‡ã‚¸ã‚¿ãƒ«æ©Ÿå™¨ã¯è«–ç†ã‚²ãƒ¼ãƒˆã¨ã„ã†æ§‹æˆè¦ç´ ã®æŒã¡ã¾ã™ã€‚
ANDã‚²ãƒ¼ãƒˆã‚„ORã‚²ãƒ¼ãƒˆã„ã£ãŸã‚‚ã®ã§ã™ã€‚ãã—ã¦ãã‚Œã‚‰ã®ã‚²ãƒ¼ãƒˆã¯ã™ã¹ã¦NANDã‚²ãƒ¼ãƒˆã®çµ„ã¿åˆã‚ã›ã§å®Ÿç¾ã§ãã¾ã™ã€‚
ã“ã®ç« ã§ã¯NADNã‚²ãƒ¼ãƒˆã‚’ä½œæˆã—ãã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«è¤‡æ•°ã®è«–ç†ã‚²ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€NANDã‚²ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã§ãã¾ã™ã€‚

```swift
public static func nand(a: Bit, b: Bit) -> Bit {
    .init(!(a.value && b.value))
}
```

ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ä»–ã®ã‚ã‚‰ã‚†ã‚‹ã‚²ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

## 2ç« ã€€ãƒ–ãƒ¼ãƒ«ç®—è¡“

â˜…â˜…â˜†â˜†â˜†

åŸºæœ¬çš„ãªè«–ç†ã‚²ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã€è¨ˆç®—ã‚’ã§ãã‚‹ã‚ˆã†ãªã‚²ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
ãã—ã¦ã€è«–ç†æ¼”ç®—ã¨ç®—è¡“æ¼”ç®—ã‚’å‡¦ç†ã™ã‚‹ALUï¼ˆç®—è¡“è«–ç†æ¼”ç®—å™¨ï¼‰ã¨ã„ã†ã‚‚ã®ã‚’ä½œæˆã—ã¾ã™ã€‚
ALUã¯è¤‡æ•°ã®é–¢æ•°ã‚’ã‚‚ã£ã¦ãŠã‚Šã€ãã®ã†ã¡ã©ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã‹ã‚’åˆ¶å¾¡ãƒ“ãƒƒãƒˆã‚’ç”¨ã„ã¦æ±ºã‚ã¾ã™ã€‚

```swift
struct ALU: ALUProtocol  {
    public static func alu(x: Bit16, y: Bit16, zx: Bit, nx: Bit, zy: Bit, ny: Bit, f: Bit, no: Bit) -> ALUOutput {
        
        let x = negate(zero(x, control: zx), control: nx)
        let y = negate(zero(y, control: zy), control: ny)
        let tmp = selectFunction(a: x, b: y, control: f)
        let out = negate(tmp, control: no)
        
        return .init(out: out, zr: out.isZero, ng: out.isNegative)
    }
    
    static func zero(_ input: Bit16, control: Bit) -> Bit16 {
        MultiGate.mux16(a: input, b: Bit16.allZero, sel: control)
    }
    
    static func negate(_ input: Bit16, control: Bit) -> Bit16 {
        MultiGate.mux16(a: input, b: MultiGate.not16(a: input), sel: control)
    }
    
    static func selectFunction(a: Bit16, b: Bit16, control: Bit) -> Bit16 {
        MultiGate.mux16(a: MultiGate.and16(a: a, b: b), b: Adder16.add(a: a, b: b), sel: control)
    }
}
```



## 3ç« ã€€é †åºå›è·¯

â˜…â˜…â˜…â˜†â˜†

çŠ¶æ…‹ã‚’ä¿æŒã§ãã‚‹ã‚ˆã†ã« = t ã¨ t-1 ã¨ã®é–¢ä¿‚æ€§ãŒç”Ÿã¾ã‚Œã‚‹ã‚ˆã†ã«é †åºå›è·¯ã‚’ä½œæˆã—ã¾ã™ã€‚
ãã®ä¸­ã§ã‚‚æœ¬æ›¸ã§ã¯Då‹ãƒ•ãƒªãƒƒãƒ—ãƒ•ãƒ­ãƒƒãƒ—ï¼ˆDFFï¼‰ã¨ã„ã†ã‚¿ã‚¤ãƒ—ã‚‚ã®ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

ã¾ãŸã€ãã‚Œã‚’ã‚‚ã¨ã«ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿/èª­ã¿è¾¼ã¿ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã«ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚
ãã—ã¦CPUã«ãŠã„ã¦ã€ã€Œæ¬¡ã«å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’ç¤ºã™ã‚‚ã®ã¨ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚‚ä½œæˆã—ã¾ã™ãŒã€ãã‚Œã‚‚ãƒ¬ã‚¸ã‚¹ã‚¿ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ä½œæˆã§ãã¾ã™ã€‚

```swift
/// 1ã¤å‰ã®å€¤ã‚’å…¥åŠ›ã‚’å‡ºåŠ›ã™ã‚‹ã‚²ãƒ¼ãƒˆ
struct DFF: DFFProtocol {
    var `in`: Bit
    
    init(_ initialValue: Bit) {
        `in` = initialValue
    }
    
    mutating func dff(_ input: Bit) -> Bit {
        defer { `in` = input }
        return `in`
    }
}
```

```swift
///ã€€å€¤ã®èª­ã¿æ›¸ããŒå¯èƒ½ãªå›è·¯
struct Register: RegisterProtocol {
    var dffGate: DFF = DFF(.init(false))
    var load: Bit = .init(false)
    var preOut: Bit = .init(false)

    mutating func output(in: Bit, load: Bit) -> Bit {
        let out = Gate.mux(a: preOut, b: dffGate.dff(`in`), sel: self.load)
       
        self.load = load
        preOut = out
        
        return out
    }
}
```

```swift
struct ProgramCounter {
    private var register16: Register16 = Register16()
    
    mutating func output(`in`: Bit16, inc: Bit, load: Bit, reset: Bit) -> Bit16 {
        let preValue: Bit16 = register16.output(in: `in`, load: .init(false))
        
        let val = MultiGate.mux8Way16(a: preValue,
                                      b: Adder16.inc(a: preValue),
                                      c: `in`,
                                      d: `in`,
                                      e: Bit16.allZero,
                                      f: Bit16.allZero,
                                      g: Bit16.allZero,
                                      h: Bit16.allZero,
                                      sel: .init((reset,
                                                  load,
                                                  inc)))
        
        return register16.output(in: val, load: .init(true))
    }
}
```



## 4ç« ã€€æ©Ÿæ¢°èª

â˜…â˜…â˜…â˜†â˜†

æ©Ÿæ¢°èªï¼ˆ1010001100011001ã®ã‚ˆã†ãªãƒã‚¤ãƒŠãƒªï¼‰ã®ä»•æ§˜ã¨ã€ãã‚Œã¨ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªï¼ˆã‚¢ã‚»ãƒ³ãƒ–ãƒªï¼‰ã®é–¢ä¿‚ã«ã¤ã„ã¦ã®ç« ã§ã™ã€‚

æ©Ÿæ¢°èªï¼šCPUã€ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ç”¨ã„ã¦ãƒ¡ãƒ¢ãƒªã‚’æ“ä½œã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªï¼šæ©Ÿæ¢°èªã®å‘½ä»¤ã‚’ã€ŒADD, R3, R1, R9ã€ã®ã‚ˆã†ãªè¨˜å·ã‚’ç”¨ã„ã¦è¡¨ç¾ã§ãã‚‹

6ç« ãŒã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã«ã¤ã„ã¦ã®ç« ãªã®ã§ã€ãã®å†…å®¹ã‚’åˆã‚ã›ã‚‹ã“ã¨ã§Swiftã§ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ï¼ˆã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‹ã‚‰æ©Ÿæ¢°èªã§ã‚ã‚‹ãƒã‚¤ãƒŠãƒªã¸ã¨å¤‰æ›ã™ã‚‹ã‚‚ã®ï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

## 5ç« ã€€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

â˜…â˜…â˜…â˜…â˜†

1~3ç« ã§ä½œæˆã—ãŸå›è·¯ã‚’åˆ©ç”¨ã—ã¦CPUã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ä½œã‚Šã¾ã™ã€‚

CPUã®å½¹å‰²ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‘½ä»¤ã®å®Ÿè¡Œã¨æ¬¡ã®å‘½ä»¤ã‚’å–å¾—ã§ã™ã€‚
CPUã¯å‘½ä»¤ãƒ¡ãƒ¢ãƒªã€ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¢ãƒªã«æ¥ç¶šã•ã‚Œã¦ãŠã‚Šãã®åå‰ã®é€šã‚Šã€å‘½ä»¤ãƒ¡ãƒ¢ãƒªã‹ã‚‰ã¯å‘½ä»¤ã‚’å–å¾—ã—ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¢ãƒªã«å¯¾ã—ã¦ã¯å€¤ã®èª­ã¿æ›¸ãã‚’è¡Œã„ã¾ã™ã€‚

CPUå‡¦ç†ã®å¤§ã¾ã‹ãªæµã‚Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ï¼ˆå›³ï¼‰

ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯Hack æ©Ÿæ¢°èªã¨å‘¼ã°ã‚Œã‚‹æœ¬æ›¸ã®å¾ŒåŠã§ä½œæˆã™ã‚‹è¨€èªã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸã€ãƒã‚¤ãƒãƒ³å‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ã™ã€‚ãƒã‚¤ãƒãƒ³å‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯CPUã‚’ç”¨ã„ã¦ã€ãƒ¡ãƒ¢ãƒªãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã—ã€å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šå‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã¾ãŸã“ã‚Œã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…è”µæ–¹å¼ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ãƒ¡ãƒ¢ãƒªã«ã¯è¨ˆç®—ãƒ‡ãƒ¼ã‚¿ã¨å…±ã«å‘½ä»¤ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã¾ã‚Œã¾ã™ã€‚å¾“ã£ã¦èª­ã¿è¾¼ã‚€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ã•ã¾ã–ã¾ãªå‘½ä»¤ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

## 6ç« ã€€ã‚¢ã‚»ãƒ³ãƒ–ãƒ©

â˜…â˜…â˜…â˜†â˜†
ä»•æ§˜é€šã‚Šã«å®Ÿè£…ã—ã¦ã„ã‘ã°è‰¯ã„ã®ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒå¤šãã¾ãŸãã®ä¿®æ­£ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸã€‚

æœ¬ç« ã§ã¯ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ãŒæ©Ÿæ¢°èªã«ã©ã®ã‚ˆã†ã«å¤‰æ›ã—ã¦ã„ã‚‹ã‹ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¸»ãªå½¹å‰²ã¯ã‚·ãƒ³ãƒœãƒ«è§£æ±ºã¨ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã§ã™ã€‚
ã‚·ãƒ³ãƒœãƒ«ã¯å¤‰æ•°åã‚’è¡¨ã™ãŸã‚ã‚„ã€ç‰¹å®šã®ä½ç½®ã‚’ç¤ºã™ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚

```
LOAD R3,weight
```

ä¾‹ãˆã°ã“ã®å ´åˆã€`weight`ãŒã‚·ãƒ³ãƒœãƒ«ã§ã‚ã‚Šã€ãã®å€¤ãŒã‚ã‚‹ãƒ¡ãƒ¢ãƒªã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¤ºã—ã¾ã™ã€‚

```
LOOP:
   if i=101 goto END
   .
   .
   .
   goto LOOP
END:
   goto END
```

ã“ã®å ´åˆã€`LOOP`ã‚„`END`ãŒç‰¹å®šã®ä½ç½®ã‚’ç¤ºã™ã‚·ãƒ³ãƒœãƒ«ã§ã™ã€‚

ã“ã®`goto`ã®ç§»å‹•å…ˆã®ã‚ˆã†ã«ã‚·ãƒ³ãƒœãƒ«ã¯ãã‚ŒãŒå®šç¾©å‰ã®çŠ¶æ…‹ã§ã‚‚ã€åˆ©ç”¨ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
å¾“ã£ã¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é †ã«ãƒ‘ãƒ¼ã‚¹ã—ã¦ã„ãã®ã§ã¯ã“ã®ä»•æ§˜ã‚’æº€ãŸã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€1åº¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã‚’è¦‹ã¦ã‚·ãƒ³ãƒœãƒ«ã‚’æŠ½å‡ºã—ã€ãã®å¾Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æœ€åˆã‹ã‚‰é †ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’è¡Œã„ã¾ã™ã€‚

```swift
struct Assembler {
    .
    .
    .
    func parse(text: String) -> [String] {
        let lines: [String] = text.components(separatedBy: "\n")
      
        // ã‚·ãƒ³ãƒœãƒ«ã‚’æ¢ã—ã¦ã‚·ãƒ³ãƒœãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹
        setUpLabelSymbol(lines: lines)
        
        // ãƒ‘ãƒ¼ã‚¹
        var codes: [String] = []
        for line in lines {
            let code = parse(line: line)
            if !code.isEmpty {
                codes.append(code)
            }
        }
        
        return codes
    }
}
```

